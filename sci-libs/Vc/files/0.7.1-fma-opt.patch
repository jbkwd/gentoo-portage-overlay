--- /usr/share/cmake/Vc/OptimizeForArchitecture.cmake	2013-03-26 10:45:14.000000000 +0100
+++ /tmp/OptimizeForArchitecture.cmake	2013-09-03 10:09:20.000000000 +0200
@@ -203,13 +203,13 @@
       list(APPEND _march_flag_list "bulldozer")
       list(APPEND _march_flag_list "barcelona")
       list(APPEND _march_flag_list "core2")
-      list(APPEND _available_vector_units_list "sse" "sse2" "sse3" "ssse3" "sse4a" "sse4.1" "sse4.2" "avx" "xop" "fma4")
+      list(APPEND _available_vector_units_list "sse" "sse2" "sse3" "ssse3" "sse4a" "sse4.1" "sse4.2" "avx" "xop" "fma" "fma4")
    elseif(TARGET_ARCHITECTURE STREQUAL "bulldozer")
       list(APPEND _march_flag_list "bdver1")
       list(APPEND _march_flag_list "bulldozer")
       list(APPEND _march_flag_list "barcelona")
       list(APPEND _march_flag_list "core2")
-      list(APPEND _available_vector_units_list "sse" "sse2" "sse3" "ssse3" "sse4a" "sse4.1" "sse4.2" "avx" "xop" "fma4")
+      list(APPEND _available_vector_units_list "sse" "sse2" "sse3" "ssse3" "sse4a" "sse4.1" "sse4.2" "avx" "xop" "fma" "fma4")
    elseif(TARGET_ARCHITECTURE STREQUAL "barcelona")
       list(APPEND _march_flag_list "barcelona")
       list(APPEND _march_flag_list "core2")
@@ -243,9 +243,11 @@
          UserWarning("AVX disabled per default because of old/broken compiler")
          set(AVX_FOUND false)
          set(XOP_FOUND false)
+         set(FMA_FOUND false)
          set(FMA4_FOUND false)
       else()
          _my_find(_available_vector_units_list "avx" AVX_FOUND)
+         _my_find(_available_vector_units_list "fma" FMA_FOUND)
          if(DEFINED Vc_FMA4_INTRINSICS_BROKEN AND Vc_FMA4_INTRINSICS_BROKEN)
             UserWarning("FMA4 disabled per default because of old/broken compiler")
             set(FMA4_FOUND false)
@@ -267,8 +269,9 @@
       set(USE_SSE4a  ${SSE4a_FOUND}  CACHE BOOL "Use SSE4a. If SSE4a instructions are not enabled they will be emulated." ${_force})
       set(USE_AVX    ${AVX_FOUND}    CACHE BOOL "Use AVX. This will double some of the vector sizes relative to SSE." ${_force})
       set(USE_XOP    ${XOP_FOUND}    CACHE BOOL "Use XOP." ${_force})
+      set(USE_FMA    ${FMA_FOUND}    CACHE BOOL "Use FMA." ${_force})
       set(USE_FMA4   ${FMA4_FOUND}   CACHE BOOL "Use FMA4." ${_force})
-      mark_as_advanced(USE_SSE2 USE_SSE3 USE_SSSE3 USE_SSE4_1 USE_SSE4_2 USE_SSE4a USE_AVX USE_XOP USE_FMA4)
+      mark_as_advanced(USE_SSE2 USE_SSE3 USE_SSSE3 USE_SSE4_1 USE_SSE4_2 USE_SSE4a USE_AVX USE_XOP USE_FMA USE_FMA4)
       if(USE_SSE2)
          list(APPEND _enable_vector_unit_list "sse2")
       else(USE_SSE2)
@@ -313,6 +316,11 @@
       else()
          list(APPEND _disable_vector_unit_list "xop")
       endif()
+      if(USE_FMA)
+         list(APPEND _enable_vector_unit_list "fma")
+      else()
+         list(APPEND _disable_vector_unit_list "fma")
+      endif()
       if(USE_FMA4)
          list(APPEND _enable_vector_unit_list "fma4")
       else()
@@ -409,6 +417,8 @@
                   set(_header "ammintrin.h")
                elseif(_flag STREQUAL "avx")
                   set(_header "immintrin.h")
+               elseif(_flag STREQUAL "fma")
+                  set(_header "x86intrin.h")
                elseif(_flag STREQUAL "fma4")
                   set(_header "x86intrin.h")
                elseif(_flag STREQUAL "xop")
